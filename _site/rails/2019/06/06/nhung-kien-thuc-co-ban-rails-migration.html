<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Nh·ªØng ki·∫øn th·ª©c c∆° b·∫£n Rails Migration | Dried Jack</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Nh·ªØng ki·∫øn th·ª©c c∆° b·∫£n Rails Migration" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Rails migrations l√† g√¨, t·∫°i sao l·∫°i c√≥ n√≥ v√† d√πng n√≥ nh∆∞ th·∫ø n√†o? Theo nh∆∞ trang h∆∞·ªõng d·∫´n ch√≠nh th·ª©c c√≥ gi·ªõi thi·ªáu th√¨ migration l√† c√°ch ti·ªán l·ªùi ƒë·ªÉ thay ƒë·ªïi database (db) schema d·ªÖ d√†ng v√† th·ªëng nh·∫•t theo th·ªùi gian. V·ªõi m·ªói s·ª± thay ƒë·ªïi trong c·∫•u tr√∫c db t·ª´ ƒë·∫ßu ƒë·∫øn cu·ªëi ƒë·ªÅu ƒë∆∞·ª£c ph·∫£n √°nh h·∫øt trong migration. T·ª´ng file l√† t·ª´ng phi√™n b·∫£n, t·ª´ng l√°t c·∫Øt th·ªùi gian c·ªßa db. V√¨ migration d√πng ruby DSL n√™n kh√¥ng c·∫ßn thi·∫øt ph·∫£i t·ª± vi·∫øt SQL, gi√∫p cho c√°c thay ƒë·ªïi c≈©ng nh∆∞ schema ƒë·ªôc l·∫≠p v·ªõi database. V·ªõi nh·ªØng ƒë·ªãnh nghƒ©a nh∆∞ tr√™n th√¨ m√¨nh nghƒ© vi·ªác c√≥ migration gi√∫p √≠ch r·∫•t nhi·ªÅu cho vi·ªác qu·∫£n l√Ω c·∫•u tr√∫c db, h·ª£p t√°c l√†m vi·ªác cho nhi·ªÅu l·∫≠p tr√¨nh vi√™n trong c√πng m·ªôt nh√≥m, kh√¥ng ph·∫£i m√≥ nhi·ªÅu t·ªõi SQL v√† db. Trong nh·ªØng d·ª± √°n m√¨nh l√†m th√¨ vi·ªác ƒëi·ªÅu ch·ªânh c·∫•u tr√∫c db hi·∫øm khi ph·∫£i t·ª± vi·∫øt tay, ruby l√† ng√¥n ng·ªØ th√¢n thi·ªán n·ªØa n√™n d·ªÖ ƒë·ªçc d·ªÖ hi·ªÉu v√† d·ªÖ chia s·∫ª v·ªõi nh√≥m. ƒê√≥ l√† v√†i ƒëi·ªÉm theo kinh nghi·ªám m√¨nh th·∫•y hay v√† m√¨nh nghƒ© ƒë·ªÉ th·ªÉ hi·ªán n√≥ r√µ n√©t nh·∫•t l√† th√¥ng qua v√≠ d·ª• v√† th·ª±c h√†nh. Migration nh∆∞ ki·ªÉu theo th·ªùi gian t·ªõi m·ªói phi√™n b·∫£n migration l√† ƒëang ph·∫£n √°nh ƒë√∫ng t√¨nh tr·∫°ng hi·ªán t·∫°i c·ªßa schema t·ª´ version ƒë√≥ tr·ªü v·ªÅ tr∆∞·ªõc. M·ªói version ƒë∆∞·ª£c ph·∫£n √°nh qua nhi·ªÅu ch·ª©c nƒÉng nh∆∞ t·∫°o b·∫£ng, x√≥a b·∫£ng, th√™m c·ªôt, x√≥a c·ªôt, th√™m index, constraint,‚Ä¶ C√πng v·ªõi vi·ªác ch·∫°y migration AR (ActiveRecord) c≈©ng ƒë·ªìng th·ªùi update file db/schema.rb ph·∫£n √°nh c·∫•u tr√∫c c·ªßa database. Trong th·ª±c ti·ªÖn T·∫°o migration T√™n file migration tu√¢n th·ªß theo qui t·∫Øc s·ªë_t√™n_migration.rb. C√°c file migration ƒë∆∞·ª£c s·∫Øp x·∫øp theo t√™n file t·ª´ nh·ªè ƒë·∫øn l·ªõn. L·ªánh rails db:migrate ƒë·ªÉ migrate db. Khi migrate, rails s·∫Ω d·ª±a v√†o th·ª© t·ª± c√°c file ƒë·ªÉ th·ª±c hi·ªán migration, n·∫øu sai th·ª© t·ª± s·∫Ω x·∫£y ra nhi·ªÅu ƒë·ª•ng ch·∫°m nghi√™m tr·ªçng ph√°t sinh l·ªói v√¨ th·∫ø rails c√≥ h·ªó tr·ª£ cho ta v√†i l·ªánh t·∫°o migration k√®m theo con s·ªë ·ªü ƒë·∫ßu file ƒë∆∞·ª£c sinh ra t·ª´ th·ªùi gian theo UTC, v√≠ d·ª• 20190511031142_create_posts.rb ƒë∆∞·ª£c t·∫°o b·∫±ng l·ªánh rails g migration CreatePosts Trong file ƒë∆∞·ª£c t·∫°o ra s·∫Ω ch·ª©a ƒëo·∫°n code nh∆∞ n√†y (ƒëo·∫°n comment l√† t·ª± vi·∫øt) class CreatePosts &lt; ActiveRecord::Migration[6.0] def change create_table :posts do |t| # t.references :user, null: false, foreign_key: true # t.string :title # t.text :body # t.timestamps end end end L·ªánh t·∫°o migration c√≤n h·ªó tr·ª£ ƒë·ªãnh nghƒ©a tr∆∞·ªõc c√°c c·ªôt n·ªØa, v√≠ d·ª• nh∆∞ rails g AddCategoryToPosts category:references views:integer M·ªôt l·ªánh kh√°c kh√° h·ªØu √≠ch ƒë√≥ l√† l·ªánh t·∫°o model rails generate model Product name:string description:text t·∫°o migration nh∆∞ n√†y class CreateProducts &lt; ActiveRecord::Migration[5.0] def change create_table :products do |t| t.string :name t.text :description t.timestamps end end end Vi·∫øt v√† ch·∫°y migration ƒê·ªÉ h·ªó tr·ª£ vi·∫øt migration, rails cung c·∫•p r·∫•t nhi·ªÅu h√†m v√≠ d·ª• nh∆∞ create_table, add_column, remove_column,... c√°c b·∫°n c√≥ th·ªÉ tham kh·∫£o ·ªü nh·ªØng link sau: ActiveRecord::ConnectionAdapters::SchemaStatements, ActiveRecord::ConnectionAdapters::TableDefinition, ActiveRecord::ConnectionAdapters::Table ƒêi·ªÉm ƒë·∫∑c bi·ªát quan tr·ªçng ·ªü ƒë√¢y ƒë√≥ l√† migration cho ph√©p ta quay ng∆∞·ª£c v·ªÅ qu√° kh·ª© c√≥ nghƒ©a l√† quay tr·ªü l·∫°i phi√™n b·∫£n tr∆∞·ªõc ƒë√≥ c·ªßa db, l·ªánh ƒë·ªÉ th·ª±c thi l√† rails db:rollback, h·ªó tr·ª£ th√™m bi·∫øn STEP=s·ªë ƒë·ªÉ quay ng∆∞·ª£c l·∫°i s·ªë verion c·ªßa migration. L·ªánh n√†y l√† m·ªôt c√°ch vi·∫øt ƒë·ªÉ h·ªó tr·ª£ l·ªánh rails db:migration VERSION=s·ªë_ƒë·∫ßu_file, c√πng v·ªõi ƒë√≥ l√† l·ªánh rails db:migrate:redo STEP=s·ªë ƒë·ªÉ rollback v√† migrate l·∫°i. ƒê·ªÉ c√≥ th·ªÉ roll back th√¨ rails ph·∫£i bi·∫øt rollback nh∆∞ th·∫ø n√†o. ƒê·ªëi v·ªõi h√†m change trong migration, khi g·ªçi h√†m trong h√†m n√†y th√¨ rails s·∫Ω t·ª± ƒë·ªông rollback n·∫øu b·∫£n th√¢n h√†m ƒë∆∞·ª£c g·ªçi ƒë√≥ c√≥ th·ªÉ rollback ƒë∆∞·ª£c, n·∫øu kh√¥ng s·∫Ω raise l·ªói ActiveRecord::IrreversibleMigration. Khi ƒë√≥ ta ph·∫£i cung c·∫•p rails th√¥ng tin ƒë·ªÉ rollback l·∫°i b·∫±ng h√†m reversible, v√≠ d·ª• class ExampleMigration &lt; ActiveRecord::Migration[5.0] def change create_table :distributors do |t| t.string :zipcode end reversible do |dir| dir.up do # add a CHECK constraint execute &lt;&lt;-SQL ALTER TABLE distributors ADD CONSTRAINT zipchk CHECK (char_length(zipcode) = 5) NO INHERIT; SQL end dir.down do execute &lt;&lt;-SQL ALTER TABLE distributors DROP CONSTRAINT zipchk SQL end end add_column :users, :home_page_url, :string rename_column :users, :email, :email_address end end Ho·∫∑c kh√¥ng ta c√≥ th·ªÉ d√πng c√°ch c≈© c·ªßa rails l√† ƒë·ªãnh nghƒ©a hai h√†m up, down ƒë·ªÉ n√≥i r√µ cho rails bi·∫øt migrate l√†m g√¨ v√† rollback l√†m g√¨. class ExampleMigration &lt; ActiveRecord::Migration[5.0] def up create_table :distributors do |t| t.string :zipcode end # add a CHECK constraint execute &lt;&lt;-SQL ALTER TABLE distributors ADD CONSTRAINT zipchk CHECK (char_length(zipcode) = 5); SQL add_column :users, :home_page_url, :string rename_column :users, :email, :email_address end def down rename_column :users, :email_address, :email remove_column :users, :home_page_url execute &lt;&lt;-SQL ALTER TABLE distributors DROP CONSTRAINT zipchk SQL drop_table :distributors end end M·ªôt h√†m kh√°c c≈©ng kh√° hay d√πng ƒë·ªÉ rollback trong migration ƒë√≥ l√† h√†m revert, khi g·ªçi h√†m n√†y n√≥ s·∫Ω revert l·∫°i ƒë√∫ng nh·ªØng g√¨ ta cung c·∫•p (block ho·∫∑c class) gi·ªëng v·ªõi l·ªánh rails db:rollback require_relative &#39;20121212123456_example_migration&#39; class FixupExampleMigration &lt; ActiveRecord::Migration[5.0] def change revert ExampleMigration create_table(:apples) do |t| t.string :variety end end end File tr√™n c≈©ng c√≥ th·ªÉ ƒë∆∞·ª£c vi·∫øt l·∫°i m√† kh√¥ng d√πng revert nh∆∞ng ta ph·∫£i ƒë·ªÉ √Ω nhi·ªÅu th·ª© h∆°n nh∆∞ l√† ƒë·ªïi l·∫°i th·ª© t·ª± c√°c l·ªánh trong h√†m change, ƒë·ªïi ng∆∞·ª£c l·∫°i up v√† down, chuy·ªÉn create_table th√†nh drop_table, r·∫Øc r·ªëi h∆°n. T·ªïng k·∫øt Tr√™n l√† m·ªôt v√†i ƒëi·ªÉm c·∫ßn bi·∫øt tr∆∞·ªõc nh·∫•t v·ªÅ rails migration, nh∆∞ l√† c√¥ng d·ª•ng c√°ch vi·∫øt, c√°c l·ªánh h·ªØu √≠ch, rollback,‚Ä¶ g·ªçi l√† c√°c l·ªánh hay d√πng. Ngo√†i ra c√≤n m·ªôt v√†i th·ª© hay ho v·ªÅ migration nh∆∞ ch·∫°y migration cho c√°c m√¥i tr∆∞·ªùng kh√°c nhau, ch·∫°y phi√™n b·∫£n c·ªë ƒë·ªãnh migration, thay ƒë·ªïi output cho migration, c·ªôt modifier,‚Ä¶ s·∫Ω d√†nh cho c√°c b·∫°n t√¨m hi·ªÉu s√¢u h∆°n. N·∫øu th·∫•y c√≥ g√¨ g√≥p √Ω th√¨ c·ª© mail li√™n h·ªá ho·∫∑c contribute nh√©. R·∫•t nhi·ªÅu y√™u th∆∞∆°ng üíñ" />
<meta property="og:description" content="Rails migrations l√† g√¨, t·∫°i sao l·∫°i c√≥ n√≥ v√† d√πng n√≥ nh∆∞ th·∫ø n√†o? Theo nh∆∞ trang h∆∞·ªõng d·∫´n ch√≠nh th·ª©c c√≥ gi·ªõi thi·ªáu th√¨ migration l√† c√°ch ti·ªán l·ªùi ƒë·ªÉ thay ƒë·ªïi database (db) schema d·ªÖ d√†ng v√† th·ªëng nh·∫•t theo th·ªùi gian. V·ªõi m·ªói s·ª± thay ƒë·ªïi trong c·∫•u tr√∫c db t·ª´ ƒë·∫ßu ƒë·∫øn cu·ªëi ƒë·ªÅu ƒë∆∞·ª£c ph·∫£n √°nh h·∫øt trong migration. T·ª´ng file l√† t·ª´ng phi√™n b·∫£n, t·ª´ng l√°t c·∫Øt th·ªùi gian c·ªßa db. V√¨ migration d√πng ruby DSL n√™n kh√¥ng c·∫ßn thi·∫øt ph·∫£i t·ª± vi·∫øt SQL, gi√∫p cho c√°c thay ƒë·ªïi c≈©ng nh∆∞ schema ƒë·ªôc l·∫≠p v·ªõi database. V·ªõi nh·ªØng ƒë·ªãnh nghƒ©a nh∆∞ tr√™n th√¨ m√¨nh nghƒ© vi·ªác c√≥ migration gi√∫p √≠ch r·∫•t nhi·ªÅu cho vi·ªác qu·∫£n l√Ω c·∫•u tr√∫c db, h·ª£p t√°c l√†m vi·ªác cho nhi·ªÅu l·∫≠p tr√¨nh vi√™n trong c√πng m·ªôt nh√≥m, kh√¥ng ph·∫£i m√≥ nhi·ªÅu t·ªõi SQL v√† db. Trong nh·ªØng d·ª± √°n m√¨nh l√†m th√¨ vi·ªác ƒëi·ªÅu ch·ªânh c·∫•u tr√∫c db hi·∫øm khi ph·∫£i t·ª± vi·∫øt tay, ruby l√† ng√¥n ng·ªØ th√¢n thi·ªán n·ªØa n√™n d·ªÖ ƒë·ªçc d·ªÖ hi·ªÉu v√† d·ªÖ chia s·∫ª v·ªõi nh√≥m. ƒê√≥ l√† v√†i ƒëi·ªÉm theo kinh nghi·ªám m√¨nh th·∫•y hay v√† m√¨nh nghƒ© ƒë·ªÉ th·ªÉ hi·ªán n√≥ r√µ n√©t nh·∫•t l√† th√¥ng qua v√≠ d·ª• v√† th·ª±c h√†nh. Migration nh∆∞ ki·ªÉu theo th·ªùi gian t·ªõi m·ªói phi√™n b·∫£n migration l√† ƒëang ph·∫£n √°nh ƒë√∫ng t√¨nh tr·∫°ng hi·ªán t·∫°i c·ªßa schema t·ª´ version ƒë√≥ tr·ªü v·ªÅ tr∆∞·ªõc. M·ªói version ƒë∆∞·ª£c ph·∫£n √°nh qua nhi·ªÅu ch·ª©c nƒÉng nh∆∞ t·∫°o b·∫£ng, x√≥a b·∫£ng, th√™m c·ªôt, x√≥a c·ªôt, th√™m index, constraint,‚Ä¶ C√πng v·ªõi vi·ªác ch·∫°y migration AR (ActiveRecord) c≈©ng ƒë·ªìng th·ªùi update file db/schema.rb ph·∫£n √°nh c·∫•u tr√∫c c·ªßa database. Trong th·ª±c ti·ªÖn T·∫°o migration T√™n file migration tu√¢n th·ªß theo qui t·∫Øc s·ªë_t√™n_migration.rb. C√°c file migration ƒë∆∞·ª£c s·∫Øp x·∫øp theo t√™n file t·ª´ nh·ªè ƒë·∫øn l·ªõn. L·ªánh rails db:migrate ƒë·ªÉ migrate db. Khi migrate, rails s·∫Ω d·ª±a v√†o th·ª© t·ª± c√°c file ƒë·ªÉ th·ª±c hi·ªán migration, n·∫øu sai th·ª© t·ª± s·∫Ω x·∫£y ra nhi·ªÅu ƒë·ª•ng ch·∫°m nghi√™m tr·ªçng ph√°t sinh l·ªói v√¨ th·∫ø rails c√≥ h·ªó tr·ª£ cho ta v√†i l·ªánh t·∫°o migration k√®m theo con s·ªë ·ªü ƒë·∫ßu file ƒë∆∞·ª£c sinh ra t·ª´ th·ªùi gian theo UTC, v√≠ d·ª• 20190511031142_create_posts.rb ƒë∆∞·ª£c t·∫°o b·∫±ng l·ªánh rails g migration CreatePosts Trong file ƒë∆∞·ª£c t·∫°o ra s·∫Ω ch·ª©a ƒëo·∫°n code nh∆∞ n√†y (ƒëo·∫°n comment l√† t·ª± vi·∫øt) class CreatePosts &lt; ActiveRecord::Migration[6.0] def change create_table :posts do |t| # t.references :user, null: false, foreign_key: true # t.string :title # t.text :body # t.timestamps end end end L·ªánh t·∫°o migration c√≤n h·ªó tr·ª£ ƒë·ªãnh nghƒ©a tr∆∞·ªõc c√°c c·ªôt n·ªØa, v√≠ d·ª• nh∆∞ rails g AddCategoryToPosts category:references views:integer M·ªôt l·ªánh kh√°c kh√° h·ªØu √≠ch ƒë√≥ l√† l·ªánh t·∫°o model rails generate model Product name:string description:text t·∫°o migration nh∆∞ n√†y class CreateProducts &lt; ActiveRecord::Migration[5.0] def change create_table :products do |t| t.string :name t.text :description t.timestamps end end end Vi·∫øt v√† ch·∫°y migration ƒê·ªÉ h·ªó tr·ª£ vi·∫øt migration, rails cung c·∫•p r·∫•t nhi·ªÅu h√†m v√≠ d·ª• nh∆∞ create_table, add_column, remove_column,... c√°c b·∫°n c√≥ th·ªÉ tham kh·∫£o ·ªü nh·ªØng link sau: ActiveRecord::ConnectionAdapters::SchemaStatements, ActiveRecord::ConnectionAdapters::TableDefinition, ActiveRecord::ConnectionAdapters::Table ƒêi·ªÉm ƒë·∫∑c bi·ªát quan tr·ªçng ·ªü ƒë√¢y ƒë√≥ l√† migration cho ph√©p ta quay ng∆∞·ª£c v·ªÅ qu√° kh·ª© c√≥ nghƒ©a l√† quay tr·ªü l·∫°i phi√™n b·∫£n tr∆∞·ªõc ƒë√≥ c·ªßa db, l·ªánh ƒë·ªÉ th·ª±c thi l√† rails db:rollback, h·ªó tr·ª£ th√™m bi·∫øn STEP=s·ªë ƒë·ªÉ quay ng∆∞·ª£c l·∫°i s·ªë verion c·ªßa migration. L·ªánh n√†y l√† m·ªôt c√°ch vi·∫øt ƒë·ªÉ h·ªó tr·ª£ l·ªánh rails db:migration VERSION=s·ªë_ƒë·∫ßu_file, c√πng v·ªõi ƒë√≥ l√† l·ªánh rails db:migrate:redo STEP=s·ªë ƒë·ªÉ rollback v√† migrate l·∫°i. ƒê·ªÉ c√≥ th·ªÉ roll back th√¨ rails ph·∫£i bi·∫øt rollback nh∆∞ th·∫ø n√†o. ƒê·ªëi v·ªõi h√†m change trong migration, khi g·ªçi h√†m trong h√†m n√†y th√¨ rails s·∫Ω t·ª± ƒë·ªông rollback n·∫øu b·∫£n th√¢n h√†m ƒë∆∞·ª£c g·ªçi ƒë√≥ c√≥ th·ªÉ rollback ƒë∆∞·ª£c, n·∫øu kh√¥ng s·∫Ω raise l·ªói ActiveRecord::IrreversibleMigration. Khi ƒë√≥ ta ph·∫£i cung c·∫•p rails th√¥ng tin ƒë·ªÉ rollback l·∫°i b·∫±ng h√†m reversible, v√≠ d·ª• class ExampleMigration &lt; ActiveRecord::Migration[5.0] def change create_table :distributors do |t| t.string :zipcode end reversible do |dir| dir.up do # add a CHECK constraint execute &lt;&lt;-SQL ALTER TABLE distributors ADD CONSTRAINT zipchk CHECK (char_length(zipcode) = 5) NO INHERIT; SQL end dir.down do execute &lt;&lt;-SQL ALTER TABLE distributors DROP CONSTRAINT zipchk SQL end end add_column :users, :home_page_url, :string rename_column :users, :email, :email_address end end Ho·∫∑c kh√¥ng ta c√≥ th·ªÉ d√πng c√°ch c≈© c·ªßa rails l√† ƒë·ªãnh nghƒ©a hai h√†m up, down ƒë·ªÉ n√≥i r√µ cho rails bi·∫øt migrate l√†m g√¨ v√† rollback l√†m g√¨. class ExampleMigration &lt; ActiveRecord::Migration[5.0] def up create_table :distributors do |t| t.string :zipcode end # add a CHECK constraint execute &lt;&lt;-SQL ALTER TABLE distributors ADD CONSTRAINT zipchk CHECK (char_length(zipcode) = 5); SQL add_column :users, :home_page_url, :string rename_column :users, :email, :email_address end def down rename_column :users, :email_address, :email remove_column :users, :home_page_url execute &lt;&lt;-SQL ALTER TABLE distributors DROP CONSTRAINT zipchk SQL drop_table :distributors end end M·ªôt h√†m kh√°c c≈©ng kh√° hay d√πng ƒë·ªÉ rollback trong migration ƒë√≥ l√† h√†m revert, khi g·ªçi h√†m n√†y n√≥ s·∫Ω revert l·∫°i ƒë√∫ng nh·ªØng g√¨ ta cung c·∫•p (block ho·∫∑c class) gi·ªëng v·ªõi l·ªánh rails db:rollback require_relative &#39;20121212123456_example_migration&#39; class FixupExampleMigration &lt; ActiveRecord::Migration[5.0] def change revert ExampleMigration create_table(:apples) do |t| t.string :variety end end end File tr√™n c≈©ng c√≥ th·ªÉ ƒë∆∞·ª£c vi·∫øt l·∫°i m√† kh√¥ng d√πng revert nh∆∞ng ta ph·∫£i ƒë·ªÉ √Ω nhi·ªÅu th·ª© h∆°n nh∆∞ l√† ƒë·ªïi l·∫°i th·ª© t·ª± c√°c l·ªánh trong h√†m change, ƒë·ªïi ng∆∞·ª£c l·∫°i up v√† down, chuy·ªÉn create_table th√†nh drop_table, r·∫Øc r·ªëi h∆°n. T·ªïng k·∫øt Tr√™n l√† m·ªôt v√†i ƒëi·ªÉm c·∫ßn bi·∫øt tr∆∞·ªõc nh·∫•t v·ªÅ rails migration, nh∆∞ l√† c√¥ng d·ª•ng c√°ch vi·∫øt, c√°c l·ªánh h·ªØu √≠ch, rollback,‚Ä¶ g·ªçi l√† c√°c l·ªánh hay d√πng. Ngo√†i ra c√≤n m·ªôt v√†i th·ª© hay ho v·ªÅ migration nh∆∞ ch·∫°y migration cho c√°c m√¥i tr∆∞·ªùng kh√°c nhau, ch·∫°y phi√™n b·∫£n c·ªë ƒë·ªãnh migration, thay ƒë·ªïi output cho migration, c·ªôt modifier,‚Ä¶ s·∫Ω d√†nh cho c√°c b·∫°n t√¨m hi·ªÉu s√¢u h∆°n. N·∫øu th·∫•y c√≥ g√¨ g√≥p √Ω th√¨ c·ª© mail li√™n h·ªá ho·∫∑c contribute nh√©. R·∫•t nhi·ªÅu y√™u th∆∞∆°ng üíñ" />
<link rel="canonical" href="http://localhost:4000/rails/2019/06/06/nhung-kien-thuc-co-ban-rails-migration.html" />
<meta property="og:url" content="http://localhost:4000/rails/2019/06/06/nhung-kien-thuc-co-ban-rails-migration.html" />
<meta property="og:site_name" content="Dried Jack" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-06-06T00:00:00+07:00" />
<script type="application/ld+json">
{"url":"http://localhost:4000/rails/2019/06/06/nhung-kien-thuc-co-ban-rails-migration.html","headline":"Nh·ªØng ki·∫øn th·ª©c c∆° b·∫£n Rails Migration","dateModified":"2019-06-06T00:00:00+07:00","datePublished":"2019-06-06T00:00:00+07:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/rails/2019/06/06/nhung-kien-thuc-co-ban-rails-migration.html"},"description":"Rails migrations l√† g√¨, t·∫°i sao l·∫°i c√≥ n√≥ v√† d√πng n√≥ nh∆∞ th·∫ø n√†o? Theo nh∆∞ trang h∆∞·ªõng d·∫´n ch√≠nh th·ª©c c√≥ gi·ªõi thi·ªáu th√¨ migration l√† c√°ch ti·ªán l·ªùi ƒë·ªÉ thay ƒë·ªïi database (db) schema d·ªÖ d√†ng v√† th·ªëng nh·∫•t theo th·ªùi gian. V·ªõi m·ªói s·ª± thay ƒë·ªïi trong c·∫•u tr√∫c db t·ª´ ƒë·∫ßu ƒë·∫øn cu·ªëi ƒë·ªÅu ƒë∆∞·ª£c ph·∫£n √°nh h·∫øt trong migration. T·ª´ng file l√† t·ª´ng phi√™n b·∫£n, t·ª´ng l√°t c·∫Øt th·ªùi gian c·ªßa db. V√¨ migration d√πng ruby DSL n√™n kh√¥ng c·∫ßn thi·∫øt ph·∫£i t·ª± vi·∫øt SQL, gi√∫p cho c√°c thay ƒë·ªïi c≈©ng nh∆∞ schema ƒë·ªôc l·∫≠p v·ªõi database. V·ªõi nh·ªØng ƒë·ªãnh nghƒ©a nh∆∞ tr√™n th√¨ m√¨nh nghƒ© vi·ªác c√≥ migration gi√∫p √≠ch r·∫•t nhi·ªÅu cho vi·ªác qu·∫£n l√Ω c·∫•u tr√∫c db, h·ª£p t√°c l√†m vi·ªác cho nhi·ªÅu l·∫≠p tr√¨nh vi√™n trong c√πng m·ªôt nh√≥m, kh√¥ng ph·∫£i m√≥ nhi·ªÅu t·ªõi SQL v√† db. Trong nh·ªØng d·ª± √°n m√¨nh l√†m th√¨ vi·ªác ƒëi·ªÅu ch·ªânh c·∫•u tr√∫c db hi·∫øm khi ph·∫£i t·ª± vi·∫øt tay, ruby l√† ng√¥n ng·ªØ th√¢n thi·ªán n·ªØa n√™n d·ªÖ ƒë·ªçc d·ªÖ hi·ªÉu v√† d·ªÖ chia s·∫ª v·ªõi nh√≥m. ƒê√≥ l√† v√†i ƒëi·ªÉm theo kinh nghi·ªám m√¨nh th·∫•y hay v√† m√¨nh nghƒ© ƒë·ªÉ th·ªÉ hi·ªán n√≥ r√µ n√©t nh·∫•t l√† th√¥ng qua v√≠ d·ª• v√† th·ª±c h√†nh. Migration nh∆∞ ki·ªÉu theo th·ªùi gian t·ªõi m·ªói phi√™n b·∫£n migration l√† ƒëang ph·∫£n √°nh ƒë√∫ng t√¨nh tr·∫°ng hi·ªán t·∫°i c·ªßa schema t·ª´ version ƒë√≥ tr·ªü v·ªÅ tr∆∞·ªõc. M·ªói version ƒë∆∞·ª£c ph·∫£n √°nh qua nhi·ªÅu ch·ª©c nƒÉng nh∆∞ t·∫°o b·∫£ng, x√≥a b·∫£ng, th√™m c·ªôt, x√≥a c·ªôt, th√™m index, constraint,‚Ä¶ C√πng v·ªõi vi·ªác ch·∫°y migration AR (ActiveRecord) c≈©ng ƒë·ªìng th·ªùi update file db/schema.rb ph·∫£n √°nh c·∫•u tr√∫c c·ªßa database. Trong th·ª±c ti·ªÖn T·∫°o migration T√™n file migration tu√¢n th·ªß theo qui t·∫Øc s·ªë_t√™n_migration.rb. C√°c file migration ƒë∆∞·ª£c s·∫Øp x·∫øp theo t√™n file t·ª´ nh·ªè ƒë·∫øn l·ªõn. L·ªánh rails db:migrate ƒë·ªÉ migrate db. Khi migrate, rails s·∫Ω d·ª±a v√†o th·ª© t·ª± c√°c file ƒë·ªÉ th·ª±c hi·ªán migration, n·∫øu sai th·ª© t·ª± s·∫Ω x·∫£y ra nhi·ªÅu ƒë·ª•ng ch·∫°m nghi√™m tr·ªçng ph√°t sinh l·ªói v√¨ th·∫ø rails c√≥ h·ªó tr·ª£ cho ta v√†i l·ªánh t·∫°o migration k√®m theo con s·ªë ·ªü ƒë·∫ßu file ƒë∆∞·ª£c sinh ra t·ª´ th·ªùi gian theo UTC, v√≠ d·ª• 20190511031142_create_posts.rb ƒë∆∞·ª£c t·∫°o b·∫±ng l·ªánh rails g migration CreatePosts Trong file ƒë∆∞·ª£c t·∫°o ra s·∫Ω ch·ª©a ƒëo·∫°n code nh∆∞ n√†y (ƒëo·∫°n comment l√† t·ª± vi·∫øt) class CreatePosts &lt; ActiveRecord::Migration[6.0] def change create_table :posts do |t| # t.references :user, null: false, foreign_key: true # t.string :title # t.text :body # t.timestamps end end end L·ªánh t·∫°o migration c√≤n h·ªó tr·ª£ ƒë·ªãnh nghƒ©a tr∆∞·ªõc c√°c c·ªôt n·ªØa, v√≠ d·ª• nh∆∞ rails g AddCategoryToPosts category:references views:integer M·ªôt l·ªánh kh√°c kh√° h·ªØu √≠ch ƒë√≥ l√† l·ªánh t·∫°o model rails generate model Product name:string description:text t·∫°o migration nh∆∞ n√†y class CreateProducts &lt; ActiveRecord::Migration[5.0] def change create_table :products do |t| t.string :name t.text :description t.timestamps end end end Vi·∫øt v√† ch·∫°y migration ƒê·ªÉ h·ªó tr·ª£ vi·∫øt migration, rails cung c·∫•p r·∫•t nhi·ªÅu h√†m v√≠ d·ª• nh∆∞ create_table, add_column, remove_column,... c√°c b·∫°n c√≥ th·ªÉ tham kh·∫£o ·ªü nh·ªØng link sau: ActiveRecord::ConnectionAdapters::SchemaStatements, ActiveRecord::ConnectionAdapters::TableDefinition, ActiveRecord::ConnectionAdapters::Table ƒêi·ªÉm ƒë·∫∑c bi·ªát quan tr·ªçng ·ªü ƒë√¢y ƒë√≥ l√† migration cho ph√©p ta quay ng∆∞·ª£c v·ªÅ qu√° kh·ª© c√≥ nghƒ©a l√† quay tr·ªü l·∫°i phi√™n b·∫£n tr∆∞·ªõc ƒë√≥ c·ªßa db, l·ªánh ƒë·ªÉ th·ª±c thi l√† rails db:rollback, h·ªó tr·ª£ th√™m bi·∫øn STEP=s·ªë ƒë·ªÉ quay ng∆∞·ª£c l·∫°i s·ªë verion c·ªßa migration. L·ªánh n√†y l√† m·ªôt c√°ch vi·∫øt ƒë·ªÉ h·ªó tr·ª£ l·ªánh rails db:migration VERSION=s·ªë_ƒë·∫ßu_file, c√πng v·ªõi ƒë√≥ l√† l·ªánh rails db:migrate:redo STEP=s·ªë ƒë·ªÉ rollback v√† migrate l·∫°i. ƒê·ªÉ c√≥ th·ªÉ roll back th√¨ rails ph·∫£i bi·∫øt rollback nh∆∞ th·∫ø n√†o. ƒê·ªëi v·ªõi h√†m change trong migration, khi g·ªçi h√†m trong h√†m n√†y th√¨ rails s·∫Ω t·ª± ƒë·ªông rollback n·∫øu b·∫£n th√¢n h√†m ƒë∆∞·ª£c g·ªçi ƒë√≥ c√≥ th·ªÉ rollback ƒë∆∞·ª£c, n·∫øu kh√¥ng s·∫Ω raise l·ªói ActiveRecord::IrreversibleMigration. Khi ƒë√≥ ta ph·∫£i cung c·∫•p rails th√¥ng tin ƒë·ªÉ rollback l·∫°i b·∫±ng h√†m reversible, v√≠ d·ª• class ExampleMigration &lt; ActiveRecord::Migration[5.0] def change create_table :distributors do |t| t.string :zipcode end reversible do |dir| dir.up do # add a CHECK constraint execute &lt;&lt;-SQL ALTER TABLE distributors ADD CONSTRAINT zipchk CHECK (char_length(zipcode) = 5) NO INHERIT; SQL end dir.down do execute &lt;&lt;-SQL ALTER TABLE distributors DROP CONSTRAINT zipchk SQL end end add_column :users, :home_page_url, :string rename_column :users, :email, :email_address end end Ho·∫∑c kh√¥ng ta c√≥ th·ªÉ d√πng c√°ch c≈© c·ªßa rails l√† ƒë·ªãnh nghƒ©a hai h√†m up, down ƒë·ªÉ n√≥i r√µ cho rails bi·∫øt migrate l√†m g√¨ v√† rollback l√†m g√¨. class ExampleMigration &lt; ActiveRecord::Migration[5.0] def up create_table :distributors do |t| t.string :zipcode end # add a CHECK constraint execute &lt;&lt;-SQL ALTER TABLE distributors ADD CONSTRAINT zipchk CHECK (char_length(zipcode) = 5); SQL add_column :users, :home_page_url, :string rename_column :users, :email, :email_address end def down rename_column :users, :email_address, :email remove_column :users, :home_page_url execute &lt;&lt;-SQL ALTER TABLE distributors DROP CONSTRAINT zipchk SQL drop_table :distributors end end M·ªôt h√†m kh√°c c≈©ng kh√° hay d√πng ƒë·ªÉ rollback trong migration ƒë√≥ l√† h√†m revert, khi g·ªçi h√†m n√†y n√≥ s·∫Ω revert l·∫°i ƒë√∫ng nh·ªØng g√¨ ta cung c·∫•p (block ho·∫∑c class) gi·ªëng v·ªõi l·ªánh rails db:rollback require_relative &#39;20121212123456_example_migration&#39; class FixupExampleMigration &lt; ActiveRecord::Migration[5.0] def change revert ExampleMigration create_table(:apples) do |t| t.string :variety end end end File tr√™n c≈©ng c√≥ th·ªÉ ƒë∆∞·ª£c vi·∫øt l·∫°i m√† kh√¥ng d√πng revert nh∆∞ng ta ph·∫£i ƒë·ªÉ √Ω nhi·ªÅu th·ª© h∆°n nh∆∞ l√† ƒë·ªïi l·∫°i th·ª© t·ª± c√°c l·ªánh trong h√†m change, ƒë·ªïi ng∆∞·ª£c l·∫°i up v√† down, chuy·ªÉn create_table th√†nh drop_table, r·∫Øc r·ªëi h∆°n. T·ªïng k·∫øt Tr√™n l√† m·ªôt v√†i ƒëi·ªÉm c·∫ßn bi·∫øt tr∆∞·ªõc nh·∫•t v·ªÅ rails migration, nh∆∞ l√† c√¥ng d·ª•ng c√°ch vi·∫øt, c√°c l·ªánh h·ªØu √≠ch, rollback,‚Ä¶ g·ªçi l√† c√°c l·ªánh hay d√πng. Ngo√†i ra c√≤n m·ªôt v√†i th·ª© hay ho v·ªÅ migration nh∆∞ ch·∫°y migration cho c√°c m√¥i tr∆∞·ªùng kh√°c nhau, ch·∫°y phi√™n b·∫£n c·ªë ƒë·ªãnh migration, thay ƒë·ªïi output cho migration, c·ªôt modifier,‚Ä¶ s·∫Ω d√†nh cho c√°c b·∫°n t√¨m hi·ªÉu s√¢u h∆°n. N·∫øu th·∫•y c√≥ g√¨ g√≥p √Ω th√¨ c·ª© mail li√™n h·ªá ho·∫∑c contribute nh√©. R·∫•t nhi·ªÅu y√™u th∆∞∆°ng üíñ","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Dried Jack" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Dried Jack</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">V·ªÅ t√¥i</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Nh·ªØng ki·∫øn th·ª©c c∆° b·∫£n Rails Migration</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2019-06-06T00:00:00+07:00" itemprop="datePublished">Jun 6, 2019
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="rails-migrations-l√†-g√¨-t·∫°i-sao-l·∫°i-c√≥-n√≥-v√†-d√πng-n√≥-nh∆∞-th·∫ø-n√†o">Rails migrations l√† g√¨, t·∫°i sao l·∫°i c√≥ n√≥ v√† d√πng n√≥ nh∆∞ th·∫ø n√†o?</h2>

<p>Theo nh∆∞ trang h∆∞·ªõng d·∫´n ch√≠nh th·ª©c c√≥ gi·ªõi thi·ªáu th√¨ migration l√† c√°ch ti·ªán l·ªùi ƒë·ªÉ thay ƒë·ªïi database (db) schema d·ªÖ d√†ng v√†
 th·ªëng nh·∫•t theo th·ªùi gian. V·ªõi m·ªói s·ª± thay ƒë·ªïi trong c·∫•u tr√∫c db t·ª´ ƒë·∫ßu ƒë·∫øn cu·ªëi ƒë·ªÅu ƒë∆∞·ª£c ph·∫£n √°nh h·∫øt trong migration.
 T·ª´ng file l√† t·ª´ng phi√™n b·∫£n, t·ª´ng l√°t c·∫Øt th·ªùi gian c·ªßa db. V√¨ migration d√πng ruby DSL n√™n kh√¥ng c·∫ßn thi·∫øt ph·∫£i t·ª± vi·∫øt SQL,
 gi√∫p cho c√°c thay ƒë·ªïi c≈©ng nh∆∞ schema ƒë·ªôc l·∫≠p v·ªõi database.</p>

<p>V·ªõi nh·ªØng ƒë·ªãnh nghƒ©a nh∆∞ tr√™n th√¨ m√¨nh nghƒ© vi·ªác c√≥ migration gi√∫p √≠ch r·∫•t nhi·ªÅu cho vi·ªác qu·∫£n l√Ω c·∫•u tr√∫c db, h·ª£p t√°c l√†m
 vi·ªác cho nhi·ªÅu l·∫≠p tr√¨nh vi√™n trong c√πng m·ªôt nh√≥m, kh√¥ng ph·∫£i m√≥ nhi·ªÅu t·ªõi SQL v√† db. Trong nh·ªØng d·ª± √°n m√¨nh l√†m th√¨
 vi·ªác ƒëi·ªÅu ch·ªânh c·∫•u tr√∫c db hi·∫øm khi ph·∫£i t·ª± vi·∫øt tay, ruby l√† ng√¥n ng·ªØ th√¢n thi·ªán n·ªØa n√™n d·ªÖ ƒë·ªçc d·ªÖ hi·ªÉu v√† d·ªÖ chia s·∫ª v·ªõi nh√≥m.
 ƒê√≥ l√† v√†i ƒëi·ªÉm theo kinh nghi·ªám m√¨nh th·∫•y hay v√† m√¨nh nghƒ© ƒë·ªÉ th·ªÉ hi·ªán n√≥ r√µ n√©t nh·∫•t l√† th√¥ng qua v√≠ d·ª• v√† th·ª±c h√†nh.</p>

<p>Migration nh∆∞ ki·ªÉu theo th·ªùi gian t·ªõi m·ªói phi√™n b·∫£n migration l√† ƒëang ph·∫£n √°nh ƒë√∫ng t√¨nh tr·∫°ng hi·ªán t·∫°i c·ªßa schema t·ª´
 version ƒë√≥ tr·ªü v·ªÅ tr∆∞·ªõc. M·ªói version ƒë∆∞·ª£c ph·∫£n √°nh qua nhi·ªÅu ch·ª©c nƒÉng nh∆∞ t·∫°o b·∫£ng, x√≥a b·∫£ng, th√™m c·ªôt, x√≥a c·ªôt,
 th√™m index, constraint,‚Ä¶ C√πng v·ªõi vi·ªác ch·∫°y migration AR (<em>ActiveRecord</em>) c≈©ng ƒë·ªìng th·ªùi update file <code class="highlighter-rouge">db/schema.rb</code>
 ph·∫£n √°nh c·∫•u tr√∫c c·ªßa database.</p>

<h2 id="trong-th·ª±c-ti·ªÖn">Trong th·ª±c ti·ªÖn</h2>

<h3 id="t·∫°o-migration">T·∫°o migration</h3>

<p>T√™n file migration tu√¢n th·ªß theo qui t·∫Øc <em>s·ªë_t√™n_migration.rb</em>. C√°c file migration ƒë∆∞·ª£c s·∫Øp x·∫øp theo t√™n file t·ª´ nh·ªè ƒë·∫øn l·ªõn.
 L·ªánh <code class="highlighter-rouge">rails db:migrate</code> ƒë·ªÉ migrate db. Khi migrate, rails s·∫Ω d·ª±a v√†o th·ª© t·ª± c√°c file ƒë·ªÉ th·ª±c hi·ªán migration, n·∫øu sai th·ª© t·ª±
 s·∫Ω x·∫£y ra nhi·ªÅu ƒë·ª•ng ch·∫°m nghi√™m tr·ªçng ph√°t sinh l·ªói v√¨ th·∫ø rails c√≥ h·ªó tr·ª£ cho ta v√†i l·ªánh t·∫°o migration k√®m theo con s·ªë ·ªü
 ƒë·∫ßu file ƒë∆∞·ª£c sinh ra t·ª´ th·ªùi gian theo UTC, v√≠ d·ª• <em>20190511031142_create_posts.rb</em> ƒë∆∞·ª£c t·∫°o b·∫±ng l·ªánh</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> rails g migration CreatePosts
</code></pre></div></div>
<p>Trong file ƒë∆∞·ª£c t·∫°o ra s·∫Ω ch·ª©a ƒëo·∫°n code nh∆∞ n√†y (ƒëo·∫°n comment l√† t·ª± vi·∫øt)</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">class</span> <span class="nc">CreatePosts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:posts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="c1"># t.references :user, null: false, foreign_key: true</span>
      <span class="c1"># t.string :title</span>
      <span class="c1"># t.text :body</span>

      <span class="c1"># t.timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<p>L·ªánh t·∫°o migration c√≤n h·ªó tr·ª£ ƒë·ªãnh nghƒ©a tr∆∞·ªõc c√°c c·ªôt n·ªØa, v√≠ d·ª• nh∆∞</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails g AddCategoryToPosts category:references views:integer
</code></pre></div></div>
<p>M·ªôt l·ªánh kh√°c kh√° h·ªØu √≠ch ƒë√≥ l√† l·ªánh t·∫°o model</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails generate model Product name:string description:text
</code></pre></div></div>
<p>t·∫°o migration nh∆∞ n√†y</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">text</span> <span class="ss">:description</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="vi·∫øt-v√†-ch·∫°y-migration">Vi·∫øt v√† ch·∫°y migration</h3>

<p>ƒê·ªÉ h·ªó tr·ª£ vi·∫øt migration, rails cung c·∫•p r·∫•t nhi·ªÅu h√†m v√≠ d·ª• nh∆∞ <code class="highlighter-rouge">create_table, add_column, remove_column,...</code>
 c√°c b·∫°n c√≥ th·ªÉ tham kh·∫£o ·ªü nh·ªØng link sau:
 <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html">ActiveRecord::ConnectionAdapters::SchemaStatements</a>,
 <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/TableDefinition.html">ActiveRecord::ConnectionAdapters::TableDefinition</a>,
 <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/Table.html">ActiveRecord::ConnectionAdapters::Table</a></p>

<p>ƒêi·ªÉm ƒë·∫∑c bi·ªát quan tr·ªçng ·ªü ƒë√¢y ƒë√≥ l√† migration cho ph√©p ta <em>quay ng∆∞·ª£c v·ªÅ qu√° kh·ª©</em> c√≥ nghƒ©a l√† quay tr·ªü l·∫°i
 phi√™n b·∫£n tr∆∞·ªõc ƒë√≥ c·ªßa db, l·ªánh ƒë·ªÉ th·ª±c thi l√† <code class="highlighter-rouge">rails db:rollback</code>, h·ªó tr·ª£ th√™m bi·∫øn <code class="highlighter-rouge">STEP=s·ªë</code> ƒë·ªÉ quay ng∆∞·ª£c
 l·∫°i <em>s·ªë</em> verion c·ªßa migration. L·ªánh n√†y l√† m·ªôt c√°ch vi·∫øt ƒë·ªÉ h·ªó tr·ª£ l·ªánh <code class="highlighter-rouge">rails db:migration VERSION=s·ªë_ƒë·∫ßu_file</code>,
 c√πng v·ªõi ƒë√≥ l√† l·ªánh <code class="highlighter-rouge">rails db:migrate:redo STEP=s·ªë</code> ƒë·ªÉ rollback v√† migrate l·∫°i.</p>

<p>ƒê·ªÉ c√≥ th·ªÉ roll back th√¨ rails ph·∫£i bi·∫øt rollback nh∆∞ th·∫ø n√†o. ƒê·ªëi v·ªõi h√†m change trong migration, khi g·ªçi
h√†m trong h√†m n√†y th√¨ rails s·∫Ω t·ª± ƒë·ªông rollback n·∫øu b·∫£n th√¢n h√†m ƒë∆∞·ª£c g·ªçi ƒë√≥ c√≥ th·ªÉ rollback ƒë∆∞·ª£c, n·∫øu kh√¥ng
s·∫Ω raise l·ªói <code class="highlighter-rouge">ActiveRecord::IrreversibleMigration</code>. Khi ƒë√≥ ta ph·∫£i cung c·∫•p rails th√¥ng tin ƒë·ªÉ rollback l·∫°i
b·∫±ng h√†m <code class="highlighter-rouge">reversible</code>, v√≠ d·ª•</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ExampleMigration</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:distributors</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:zipcode</span>
    <span class="k">end</span>

    <span class="n">reversible</span> <span class="k">do</span> <span class="o">|</span><span class="n">dir</span><span class="o">|</span>
      <span class="n">dir</span><span class="p">.</span><span class="nf">up</span> <span class="k">do</span>
        <span class="c1"># add a CHECK constraint</span>
        <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
          ALTER TABLE distributors
            ADD CONSTRAINT zipchk
              CHECK (char_length(zipcode) = 5) NO INHERIT;
</span><span class="no">        SQL</span>
      <span class="k">end</span>
      <span class="n">dir</span><span class="p">.</span><span class="nf">down</span> <span class="k">do</span>
        <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
          ALTER TABLE distributors
            DROP CONSTRAINT zipchk
</span><span class="no">        SQL</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:home_page_url</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">rename_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:email_address</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<p>Ho·∫∑c kh√¥ng ta c√≥ th·ªÉ d√πng c√°ch c≈© c·ªßa rails l√† ƒë·ªãnh nghƒ©a hai h√†m <code class="highlighter-rouge">up, down</code> ƒë·ªÉ n√≥i r√µ cho rails bi·∫øt migrate
 l√†m g√¨ v√† rollback l√†m g√¨.</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">class</span> <span class="nc">ExampleMigration</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">up</span>
    <span class="n">create_table</span> <span class="ss">:distributors</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:zipcode</span>
    <span class="k">end</span>

    <span class="c1"># add a CHECK constraint</span>
    <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
      ALTER TABLE distributors
        ADD CONSTRAINT zipchk
        CHECK (char_length(zipcode) = 5);
</span><span class="no">    SQL</span>

    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:home_page_url</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">rename_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:email_address</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">down</span>
    <span class="n">rename_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:email_address</span><span class="p">,</span> <span class="ss">:email</span>
    <span class="n">remove_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:home_page_url</span>

    <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
      ALTER TABLE distributors
        DROP CONSTRAINT zipchk
</span><span class="no">    SQL</span>

    <span class="n">drop_table</span> <span class="ss">:distributors</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<p>M·ªôt h√†m kh√°c c≈©ng kh√° hay d√πng ƒë·ªÉ rollback trong migration ƒë√≥ l√† h√†m <code class="highlighter-rouge">revert</code>, khi g·ªçi h√†m n√†y n√≥ s·∫Ω revert
 l·∫°i ƒë√∫ng nh·ªØng g√¨ ta cung c·∫•p (block ho·∫∑c class) gi·ªëng v·ªõi l·ªánh <code class="highlighter-rouge">rails db:rollback</code></p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nb">require_relative</span> <span class="s1">'20121212123456_example_migration'</span>

<span class="k">class</span> <span class="nc">FixupExampleMigration</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">revert</span> <span class="no">ExampleMigration</span>

    <span class="n">create_table</span><span class="p">(</span><span class="ss">:apples</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:variety</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<p>File tr√™n c≈©ng c√≥ th·ªÉ ƒë∆∞·ª£c vi·∫øt l·∫°i m√† kh√¥ng d√πng <code class="highlighter-rouge">revert</code> nh∆∞ng ta ph·∫£i ƒë·ªÉ √Ω nhi·ªÅu th·ª© h∆°n nh∆∞ l√† ƒë·ªïi l·∫°i
 th·ª© t·ª± c√°c l·ªánh trong h√†m <code class="highlighter-rouge">change</code>, ƒë·ªïi ng∆∞·ª£c l·∫°i <code class="highlighter-rouge">up</code> v√† <code class="highlighter-rouge">down</code>, chuy·ªÉn <code class="highlighter-rouge">create_table</code> th√†nh <code class="highlighter-rouge">drop_table</code>,
 r·∫Øc r·ªëi h∆°n.</p>

<h2 id="t·ªïng-k·∫øt">T·ªïng k·∫øt</h2>

<p>Tr√™n l√† m·ªôt v√†i ƒëi·ªÉm c·∫ßn bi·∫øt tr∆∞·ªõc nh·∫•t v·ªÅ rails migration, nh∆∞ l√† c√¥ng d·ª•ng c√°ch vi·∫øt, c√°c l·ªánh h·ªØu √≠ch,
 rollback,‚Ä¶ g·ªçi l√† c√°c l·ªánh hay d√πng. Ngo√†i ra c√≤n m·ªôt v√†i th·ª© hay ho v·ªÅ migration nh∆∞ ch·∫°y migration cho
 c√°c m√¥i tr∆∞·ªùng kh√°c nhau, ch·∫°y phi√™n b·∫£n c·ªë ƒë·ªãnh migration, thay ƒë·ªïi output cho migration, c·ªôt modifier,‚Ä¶
 s·∫Ω d√†nh cho c√°c b·∫°n t√¨m hi·ªÉu s√¢u h∆°n.</p>

<p>N·∫øu th·∫•y c√≥ g√¨ g√≥p √Ω th√¨ c·ª© mail li√™n h·ªá ho·∫∑c contribute nh√©.</p>

<p>R·∫•t nhi·ªÅu y√™u th∆∞∆°ng üíñ</p>

  </div><a class="u-url" href="/rails/2019/06/06/nhung-kien-thuc-co-ban-rails-migration.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Dried Jack</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Dried Jack</li><li><a class="u-email" href="mailto:driedjack@gmail.com">driedjack@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/driedjack"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">driedjack</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
